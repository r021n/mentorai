<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Manajemen Answers</title>
    <style>
      /* Basic table styles */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      th {
        background-color: #f2f2f2;
      }
      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 400px;
      }
      .modal-header {
        font-weight: bold;
        margin-bottom: 10px;
      }
      .modal-actions {
        margin-top: 20px;
        text-align: right;
      }
      .modal-actions button {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Manajemen Answers</h1>

    <!-- Filter Form -->
    <div>
      <label>User ID: </label>
      <input
        type="text"
        id="filterUserId"
        value="<%= filters.userId || '' %>"
        placeholder="Filter by user ID"
      />
      <label>Question ID: </label>
      <input
        type="text"
        id="filterQuestionId"
        value="<%= filters.questionId || '' %>"
        placeholder="Filter by question ID"
      />
      <label>Topic ID: </label>
      <input
        type="text"
        id="filterTopicId"
        value="<%= filters.topicId || '' %>"
        placeholder="Filter by topic ID"
      />
    </div>
    <br />

    <!-- Table untuk menampilkan data answers -->
    <table id="answersTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" /></th>
          <th>ID</th>
          <th>Answer</th>
          <th>Feedback</th>
          <th>Score</th>
          <th>User ID</th>
          <th>Question ID</th>
          <th>Topic ID</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        <% answers.forEach(function(ans, index) { %>
        <tr data-id="<%= ans.id %>">
          <td>
            <input
              type="checkbox"
              class="rowCheckbox"
              data-id="<%= ans.id %>"
            />
          </td>
          <td><%= ans.id %></td>
          <td class="answerCell"><%= ans.answer %></td>
          <td class="feedbackCell"><%= ans.feedback %></td>
          <td class="scoreCell"><%= ans.score %></td>
          <td class="userIdCell"><%= ans.userId %></td>
          <td class="questionIdCell"><%= ans.questionId %></td>
          <td class="topicIdCell"><%= ans.topicId %></td>
          <td><button class="editBtn" data-id="<%= ans.id %>">Edit</button></td>
        </tr>
        <% }) %>
      </tbody>
    </table>

    <!-- Tombol Delete Selected -->
    <button id="deleteSelectedBtn">Delete Selected</button>

    <!-- Modal Konfirmasi Hapus -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">Konfirmasi Hapus</div>
        <div class="modal-body">
          Apakah Anda yakin ingin menghapus data yang dipilih?
        </div>
        <div class="modal-actions">
          <button id="deleteCancelBtn">Batal</button>
          <button id="deleteConfirmBtn">Hapus</button>
        </div>
      </div>
    </div>

    <!-- Modal Edit Answer -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">Edit Answer</div>
        <div class="modal-body">
          <input type="hidden" id="editAnswerId" />
          <div>
            <label>Answer:</label>
            <input type="text" id="editAnswer" style="width: 100%" />
          </div>
          <div>
            <label>Feedback:</label>
            <input type="text" id="editFeedback" style="width: 100%" />
          </div>
          <div>
            <label>Score:</label>
            <input type="number" id="editScore" style="width: 100%" />
          </div>
          <div>
            <label>User ID:</label>
            <input type="text" id="editUserId" style="width: 100%" />
          </div>
          <div>
            <label>Question ID:</label>
            <input type="text" id="editQuestionId" style="width: 100%" />
          </div>
          <div>
            <label>Topic ID:</label>
            <input type="text" id="editTopicId" style="width: 100%" />
          </div>
        </div>
        <div class="modal-actions">
          <button id="editCancelBtn">Batal</button>
          <button id="editConfirmBtn">Konfirmasi</button>
        </div>
      </div>
    </div>

    <script>
      // -------------------------------
      // FILTERING DENGAN DEBOUNCE 1 DETIK
      let filterTimer;
      const filterUserIdInput = document.getElementById("filterUserId");
      const filterQuestionIdInput = document.getElementById("filterQuestionId");
      const filterTopicIdInput = document.getElementById("filterTopicId");

      const applyFilters = () => {
        const queryParams = new URLSearchParams({
          userId: filterUserIdInput.value,
          questionId: filterQuestionIdInput.value,
          topicId: filterTopicIdInput.value,
        });
        fetch("/database/answers/search?" + queryParams.toString())
          .then((response) => response.json())
          .then((data) => {
            updateTable(data);
          })
          .catch((err) => console.error(err));
      };

      filterUserIdInput.addEventListener("keyup", () => {
        clearTimeout(filterTimer);
        filterTimer = setTimeout(applyFilters, 1000);
      });
      filterQuestionIdInput.addEventListener("keyup", () => {
        clearTimeout(filterTimer);
        filterTimer = setTimeout(applyFilters, 1000);
      });
      filterTopicIdInput.addEventListener("keyup", () => {
        clearTimeout(filterTimer);
        filterTimer = setTimeout(applyFilters, 1000);
      });

      function updateTable(answers) {
        const tbody = document.querySelector("#answersTable tbody");
        tbody.innerHTML = "";
        answers.forEach((ans, index) => {
          const row = document.createElement("tr");
          row.setAttribute("data-id", ans.id);
          row.innerHTML = `
          <td><input type="checkbox" class="rowCheckbox" data-id="${ans.id}" /></td>
          <td>${ans.id}</td>
          <td class="answerCell">${ans.answer}</td>
          <td class="feedbackCell">${ans.feedback}</td>
          <td class="scoreCell">${ans.score}</td>
          <td class="userIdCell">${ans.userId}</td>
          <td class="questionIdCell">${ans.questionId}</td>
          <td class="topicIdCell">${ans.topicId}</td>
          <td><button class="editBtn" data-id="${ans.id}">Edit</button></td>
        `;
          tbody.appendChild(row);
        });
      }

      // -------------------------------
      // SELECT ALL CHECKBOX
      document
        .getElementById("selectAll")
        .addEventListener("change", function () {
          const checked = this.checked;
          document.querySelectorAll(".rowCheckbox").forEach((chk) => {
            chk.checked = checked;
          });
        });

      // -------------------------------
      // DELETE SELECTED DENGAN MODAL KONFIRMASI
      document
        .getElementById("deleteSelectedBtn")
        .addEventListener("click", function () {
          const selectedIds = Array.from(
            document.querySelectorAll(".rowCheckbox")
          )
            .filter((chk) => chk.checked)
            .map((chk) => chk.getAttribute("data-id"));
          if (selectedIds.length === 0) {
            alert("Tidak ada data yang dipilih!");
            return;
          }
          document.getElementById("deleteModal").style.display = "block";

          document.getElementById("deleteConfirmBtn").onclick = function () {
            fetch("/database/answers/delete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ids: selectedIds }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  selectedIds.forEach((id) => {
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) row.remove();
                  });
                } else {
                  alert(data.message || "Gagal menghapus data.");
                }
                document.getElementById("deleteModal").style.display = "none";
              })
              .catch((err) => {
                console.error(err);
                document.getElementById("deleteModal").style.display = "none";
              });
          };

          document.getElementById("deleteCancelBtn").onclick = function () {
            document.getElementById("deleteModal").style.display = "none";
          };
        });

      // -------------------------------
      // EDIT: MEMBUKA MODAL EDIT
      document.addEventListener("click", function (e) {
        if (e.target && e.target.classList.contains("editBtn")) {
          const id = e.target.getAttribute("data-id");
          const row = document.querySelector(`tr[data-id="${id}"]`);
          document.getElementById("editAnswerId").value = id;
          document.getElementById("editAnswer").value =
            row.querySelector(".answerCell").textContent;
          document.getElementById("editFeedback").value =
            row.querySelector(".feedbackCell").textContent;
          document.getElementById("editScore").value =
            row.querySelector(".scoreCell").textContent;
          document.getElementById("editUserId").value =
            row.querySelector(".userIdCell").textContent;
          document.getElementById("editQuestionId").value =
            row.querySelector(".questionIdCell").textContent;
          document.getElementById("editTopicId").value =
            row.querySelector(".topicIdCell").textContent;

          document.getElementById("editModal").style.display = "block";
        }
      });

      document
        .getElementById("editCancelBtn")
        .addEventListener("click", function () {
          document.getElementById("editModal").style.display = "none";
        });

      document
        .getElementById("editConfirmBtn")
        .addEventListener("click", function () {
          const id = document.getElementById("editAnswerId").value;
          const answer = document.getElementById("editAnswer").value;
          const feedback = document.getElementById("editFeedback").value;
          const score = document.getElementById("editScore").value;
          const userId = document.getElementById("editUserId").value;
          const questionId = document.getElementById("editQuestionId").value;
          const topicId = document.getElementById("editTopicId").value;

          fetch("/database/answers/edit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id,
              answer,
              feedback,
              score,
              userId,
              questionId,
              topicId,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                const row = document.querySelector(`tr[data-id="${id}"]`);
                row.querySelector(".answerCell").textContent = answer;
                row.querySelector(".feedbackCell").textContent = feedback;
                row.querySelector(".scoreCell").textContent = score;
                row.querySelector(".userIdCell").textContent = userId;
                row.querySelector(".questionIdCell").textContent = questionId;
                row.querySelector(".topicIdCell").textContent = topicId;
              } else {
                alert(data.message || "Gagal mengupdate data.");
              }
              document.getElementById("editModal").style.display = "none";
            })
            .catch((err) => {
              console.error(err);
              document.getElementById("editModal").style.display = "none";
            });
        });
    </script>
  </body>
</html>
